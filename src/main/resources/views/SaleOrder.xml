<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">



	<form name="ms-sale-order-form-partner" title="Sale order"
		model="com.axelor.apps.sale.db.SaleOrder"
		onNew="action-group-sale-saleorder-onnew,action-group-partner-saleorder-onnew"
		onLoad="action-group-sale-saleorder-onload" width="large">

		<panel-include view="ms-sale-order-form" />
	</form>

	<form name="ms-sale-order-form" title="Sale order" width="large"
		model="com.axelor.apps.sale.db.SaleOrder" id="ms-sale-order-form"
		onNew="action-group-sale-saleorder-onnew"
		onLoad="action-group-sale-saleorder-onload">
		<menubar>
			<menu title="Reports">
				<item action="save,ms-action-sale-order-method-show-sale-order"
					title="Print" hideIf="clientPartner == null" />
				<item
					action="save,ms-action-sale-order-method-print-proforma-invoice"
					title="Print proforma invoice" hideIf="clientPartner == null" />
				<item
					action="save,action-sale-order-method-export-sale-order-excel"
					title="Excel Export" hideIf="clientPartner == null" />
				<item
					action="save,action-sale-order-method-export-sale-order-word"
					title="Word Export" hideIf="clientPartner == null" />
			</menu>
			<menu title="Tools">
				<item title="Schedule Event"
					action="action-sale-order-view-schedule-event"
					hideIf="clientPartner == null" />
				<item action="save,action-send-by-email-with-template"
					title="Send email" hideIf="clientPartner == null" />
				<item action="save,action-sale-order-method-generate-template"
					title="Define as template" hideIf="clientPartner == null" />
			</menu>
		</menubar>

		<panel name="main" title="Infos Générales"
			showIf="$isSimplified">
			<field name="clientPartner"
				onChange="action-sale-order-group-client-partner-change,action-sale-order-record-compute-end-of-validity-date"
				onSelect="action-set-client-partner-domain" form-view="partner-form"
				grid-view="partner-grid"
				readonlyIf="saleOrderLineList.length > 0 || statusSelect &gt;= 2"
				colSpan="6" />
			<field name="contactPartner"
				onChange="action-record-so-contact-partner-change"
				onSelect="action-sale-order-domain-on-contact-partner"
				domain="self.isContact = true" form-view="partner-contact-form"
				grid-view="partner-contact-grid" colspan="6" />
			<field name="$isSimplified" colSpan="12"
				widget="InlineCheckbox" title="Vue simplifiée"></field>
		</panel> <!-- main simplifié -->


		<panel name="main" title="Infos Générales"
			showIf="!$isSimplified">
			<panel colSpan="6" title="Informations Devis">
				<field name="statusSelect" showTitle="false"
					widget="NavSelect" colSpan="12" />
				<field name="saleOrderSeq" colSpan="3"
					css="label-bold bold red" title="Numéro" />
				<field name="versionNumber" colSpan="3"
					css="label-bold bold red" title="Version"
					if="__config__.app.getApp('sale').getManageSaleOrderVersion()" />
				<field name="currency" colSpan="3" canEdit="false"
					form-view="currency-form" grid-view="currency-grid"
					readonlyIf="statusSelect &gt;= 2" />
				<field name="company" colSpan="3" canEdit="false"
					widget="SuggestBox" onChange="action-sale-group-onchange-company"
					form-view="company-form" grid-view="company-grid"
					readonlyIf="statusSelect == 3 || clientPartner != null" />
				<field name="creationDate" readonlyIf="statusSelect != 1" colSpan="3" onChange="action-sale-order-record-compute-end-of-validity-date"/>
				<field name="duration" widget="SuggestBox" canNew="true" colSpan="3" onChange="action-sale-order-record-compute-end-of-validity-date" readonlyIf="statusSelect &gt;= 2"/>
			    <field name="endOfValidityDate" colSpan="3" readonly="true">
			    	<hilite if="$moment().diff(endOfValidityDate, 'days') &gt; 0 &amp;&amp; statusSelect != 3" color="danger"/>
			    </field>
			    <field name="confirmedByUser" canNew="false" canEdit="false" canView="false" readonly="true" colSpan="3" showIf="statusSelect == 3" form-view="user-form" grid-view="user-grid"/>
			    <field name="confirmationDate" readonly="true" colSpan="3" showIf="statusSelect == 3"/>
			    <field name="orderDate" colSpan="3" showIf="statusSelect == 3"/>
			    <field name="orderNumber" colSpan="3" showIf="statusSelect == 3"/>
			    <field name="shipmentDate" colSpan="3" showIf="statusSelect == 3" if-module="axelor-supplychain"  if="__config__.app.isApp('supplychain')" />
			    <field name="expectedRealisationDate" colSpan="3" if="__config__.app.isApp('supplychain') &amp;&amp; !__config__.app.getApp('supplychain').getAllowTimetableInvoicing()"/>
		        <field name="cancelReason" hidden="true"/>
				<field name="cancelReasonStr" title="Cancel Reason" readonly="true" colSpan="12" css="red" hidden="true" showIf="cancelReason != null &amp;&amp; cancelReasonStr != null">
					<viewer><![CDATA[{{record.cancelReasonStr}}]]></viewer>
				</field>
				<field name="standardDelay" readonly="true" if-module="axelor-supplychain"   if="__config__.app.isApp('supplychain')" hidden="true" showIf="standardDelay &gt; 0" />
				
					<panel sidebar="true" name="actions" title="Actions" stacked="true" hideIf="clientPartner == null">
						<button name="finalize" title="Finalize" showIf="statusSelect == 1" colSpan="12" onClick="save,action-sale-order-method-finalize-quotation"/>
						<button name="completeManuallySaleOrder" title="Complete manually sale order" if="(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.allowCompleteManuallySaleOrder) || (!__config__.app.isApp('supplychain'))" showIf="statusSelect == 3" colSpan="12" onClick="save,action-sale-order-method-complete-sale-order"/>
						<button name="newVersion" title="New version" if="__config__.app.getApp('sale').getManageSaleOrderVersion()" showIf="statusSelect == 2" colSpan="12" onClick="save,action-sale-record-newVersion,save"/>
						<button name="editOrder" title="Edit order" if="__config__.app.getApp('sale').allowPendingOrderModification" showIf="statusSelect == 3 &amp;&amp; !orderBeingEdited" colSpan="12" onClick="action-sale-order-method-edit-order"/>
						<button name="validateChanges" title="Validate changes" showIf="statusSelect == 3 &amp;&amp; orderBeingEdited" colSpan="12" onClick="action-sale-order-validate-changes,save"/>
						<button name="generateCustomerStockMove" title="Generate customer deliveries" colSpan="12" showIf="statusSelect == 3 &amp;&amp; !orderBeingEdited"
							if="__config__.app.getApp('supplychain')?.custStockMoveMgtOnSO &amp;&amp; !__config__.app.getApp('supplychain').customerStockMoveGenerationAuto"
							readonlyIf="!saleOrderLineList || !saleOrderLineList.length"
							onClick="save, action-supplychain-sale-order-create-stock-move"/>
					   <button name="confirmOrder" title="Confirm order" showIf="statusSelect == 2" colSpan="12" onClick="save,action-sale-group-confirmed"/>
					   <button name="generateInvoice" title="Generate invoice" if="__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain').getGenerateInvoiceFromSaleOrder()" showIf="statusSelect == 3 &amp;&amp; !orderBeingEdited" colSpan="12" onClick="save,action-supplychain-sale-order-view-invoicing-wizard" if-module="axelor-supplychain"/>
					   <button name="generatePO" title="Generate purchase order"  colSpan="12" if="__config__.app.isApp('supplychain') &amp;&amp; !__config__.app.getApp('supplychain').getPurchaseOrderGenerationAuto()" showIf="(statusSelect == 2 || statusSelect == 3) &amp;&amp; !orderBeingEdited" onClick="save,action-supplychain-sale-order-generate-purchase-orders-from-selected-SOLines"/>
					   <button name="generateProductionOrder" title="Generate production order"  colSpan="12" if="__config__.app.getApp('production')?.prodOrderMgtOnSO &amp;&amp; !__config__.app.getApp('production')?.productionOrderGenerationAuto" showIf="statusSelect == 3 &amp;&amp; !orderBeingEdited" onClick="save,action-sale-order-method-create-production-order"/>
						<spacer/>
					   <button name="cancel" title="Cancel" showIf="id &amp;&amp; (statusSelect == 1 || statusSelect == 2)" colSpan="12" onClick="save,action-sale-order-view-cancel"/>
						<button name="addAdvancePayment" title="Register a deposit"
							showIf="statusSelect == 3 &amp;&amp; amountInvoiced == 0"
							colSpan="12" onClick="save,action-sale-order-view-register-advance-payment"
							if-module="axelor-supplychain"
							if="__config__.app.isApp('supplychain') &amp;&amp; !__config__.app.getApp('account').getManageAdvancePaymentInvoice()" />
						 	<field name="message" hidden="true" type="string"/>
						      <field name="amountInvoiced" hidden="true" />
						<button name="addLineFromConfigurator" title="Add Line from Configurator"
								onClick="save,action-sale-order-view-generate-line"
								showIf="statusSelect == 1"
								if="__config__.app.getApp('sale').getEnableConfigurator()"/>
					 </panel>
				
				
			</panel>
			<panel colSpan="6" title="Infos Clients">
				<field name="clientPartner"
					onChange="action-sale-order-group-client-partner-change,action-sale-order-record-compute-end-of-validity-date"
					onSelect="action-set-client-partner-domain"
					form-view="partner-form" grid-view="partner-grid"
					readonlyIf="saleOrderLineList.length > 0 || statusSelect &gt;= 2"
					colSpan="6" />
				<field name="contactPartner"
					onChange="action-record-so-contact-partner-change"
					onSelect="action-sale-order-domain-on-contact-partner"
					domain="self.isContact = true" form-view="partner-contact-form"
					grid-view="partner-contact-grid" colspan="6" />
				<panel stacked="true">
					<field name="mainInvoicingAddress" canNew="true"
						hideIf="$readonly() || statusSelect &gt; 1"
						onChange="action-sale-order-method-address-str"
						onSelect="action-sale-order-attrs-domain-main-invoicing-address"
						form-view="address-partner-address-form" grid-view="address-grid" />
					<field name="mainInvoicingAddressStr"
						readonlyIf="statusSelect &gt; 1" height="5">
						<viewer>{{record.mainInvoicingAddressStr}}</viewer>
					</field>
				</panel>
				<panel stacked="true">
					<field name="deliveryAddress" canNew="true"
						hideIf="$readonly() || statusSelect &gt; 1"
						onChange="action-sale-order-method-address-str"
						onSelect="action-sale-order-attrs-domain-delivery-address"
						form-view="address-partner-address-form" grid-view="address-grid" />
					<field name="deliveryAddressStr"
						readonlyIf="statusSelect &gt; 1" height="5">
						<viewer>{{record.deliveryAddressStr}}</viewer>
					</field>
				</panel>
				<field name="priceList"
					onSelect="action-sale-order-method-price-list-domain"
					onChange="action-sale-order-record-hide-discount"
					form-view="price-list-form" grid-view="price-list-grid"
					readonlyIf="statusSelect &gt;= 2" />
				<field name="externalReference" />
			</panel>
			<panel colSpan="12" stacked="true">
				<field name="$isSimplified" colSpan="4"
					widget="InlineCheckbox" title="Vue simplifiée"></field>
			</panel>
		</panel> <!-- main détaillé -->

		<panel id="ms-saleorder-detail" name="detail">
			<panel-related field="saleOrderLineList" colSpan="12"
				onChange="action-sale-order-line-change-group"
				form-view="ms-sale-order-line-form"
				grid-view="ms-sale-order-line-grid" height="100"
				readonlyIf="clientPartner == null || statusSelect == 2 || (statusSelect == 3 &amp;&amp; !orderBeingEdited) || statusSelect == 4"
				canMove="true" orderBy="sequence" />

			<panel sidebar="true" itemSpan="6" title="Margin"
				hideIf="clientPartner == null" readonly="true">
				<field name="totalCostPrice" />
				<field name="totalGrossMargin" />
				<field name="marginRate" />
			</panel>

			<field name="inTaxTotal" css="order-subtotal" showTitle="false"
				colSpan="6">
				<viewer
					depends="exTaxTotal,currency.symbol,taxTotal,statusSelect,amountInvoiced,advanceTotal,exTaxTotalPrimary,exTaxTotalEcoTax">
                    <![CDATA[
                    <dl class="dl-horizontal">
                        <dt x-translate>Total Brut HT</dt>
                        <dd>{{record.exTaxTotalPrimary}} {{record.currency.symbol}}</dd>
                        <dt x-translate>Total EcoTaxe HT</dt>
                        <dd>{{record.exTaxTotalEcoTax}} {{record.currency.symbol}}</dd>
                        <dt x-translate>Total NET HT</dt>
                        <dd>{{record.exTaxTotal}}  {{record.currency.symbol}}</dd>
                        <dt x-translate>Total tax</dt>
                        <dd>{{record.taxTotal}}  {{record.currency.symbol}}</dd>
                        <dt class="order-subtotal-total" x-translate>Total A.T.I.</dt>
                        <dd class="order-subtotal-total">{{record.inTaxTotal}}  {{record.currency.symbol}}</dd>
                        <dt ng-show="record.statusSelect >= 3" x-translate>Amount invoiced W.T.</dt>
                        <dd ng-show="record.statusSelect >= 3">{{record.amountInvoiced}}  {{record.currency.symbol}}</dd>
                        <dt ng-show="record.statusSelect >= 2" x-translate>Advance payment total</dt>
                        <dd ng-show="record.statusSelect >= 2">{{record.advanceTotal}}  {{record.currency.symbol}}</dd>
                    </dl>
                    ]]>
                </viewer>
			</field>
		</panel>
		<panel-mail>
			<mail-messages limit="4" />
			<mail-followers />
		</panel-mail>
	</form>


	<action-method name="ms-action-sale-order-method-show-sale-order">
		<call class="com.axelor.apps.misyl.custom.web.MisylSaleOrderController"
			method="showSaleOrder" />
	</action-method>
	<action-method name="ms-action-sale-order-method-print-proforma-invoice">
		<call class="com.axelor.apps.misyl.custom.web.MisylSaleOrderController"
			method="printProformaInvoice" />
	</action-method>

</object-views>